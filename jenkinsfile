pipeline {
    agent { 
        node {
            label 'Node1'
        }
    }
    stages {
        stages {
        stage('SCM checkout') {
            steps {
                git "https://github.com/StrakSelby/Pipe-line.git"
            }
        }
        stage('Installing ansible on the agent')
            steps{
                script{
                    sh '''
                    apt update
                    apt install software-properties-common
                    add-apt-repository --yes --update ppa:ansible/ansible
                    apt install -y ansible
                    '''
                }
            }
        stage('Setup kubernetes plugin for Ansible')
            steps{
                script{
                    sh '''
                    apt install python3-pip -y
                    pip install kubernetes
                    echo 'Edit ansible.cfg for kubernetes plugin'
                    echo "[inventory]" >> /etc/ansible/ansible.cfg
                    echo "enable_plugins = kubernetes.core.k8s" >> /etc/ansible/ansible.cfg
                    '''
                }
            }
        stage('Execute Ansible') {
            steps {
                echo 'Running playbook.......'
                ansiblePlaybook (
                    credentialsId: '5cda38a1-df71-4fc9-8cfe-19cacc50cea8',
                    disableHostKeyChecking: true,
                    installation: 'Ansible',
                    inventory: 'Ansible/inventory.k8s.yml',
                    playbook: 'Ansible/playbook.yml',
                    colorized: true)
            }
        }

        }
    }
}

